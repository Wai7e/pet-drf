<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hotel Booking</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.7.2/dist/axios.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    // Контекст для управления аутентификацией
    const AuthContext = React.createContext();

    // Компонент провайдера аутентификации
    const AuthProvider = ({ children }) => {
      const [user, setUser] = useState(null);
      const [token, setToken] = useState(localStorage.getItem('access_token') || '');

      const login = async (username, password) => {
        try {
          const response = await axios.post('http://127.0.0.1:8000/api/v1/token/', { username, password });
          setToken(response.data.access);
          localStorage.setItem('access_token', response.data.access);
          localStorage.setItem('refresh_token', response.data.refresh);
          const profile = await axios.get('http://127.0.0.1:8000/api/v1/users/profile/', {
            headers: { Authorization: `Bearer ${response.data.access}` }
          });
          setUser(profile.data);
        } catch (error) {
          console.error('Ошибка входа:', error);
          throw error;
        }
      };

      const logout = () => {
        setUser(null);
        setToken('');
        localStorage.removeItem('access_token');
        localStorage.removeItem('refresh_token');
      };

      return (
        <AuthContext.Provider value={{ user, token, login, logout }}>
          {children}
        </AuthContext.Provider>
      );
    };

    // Компонент для отображения навигации
    const Navbar = () => {
      const { user, logout } = React.useContext(AuthContext);
      return (
        <nav className="bg-blue-600 text-white p-4">
          <div className="container mx-auto flex justify-between items-center">
            <h1 className="text-2xl font-bold">Hotel Booking</h1>
            <div>
              {user ? (
                <>
                  <span className="mr-4">Привет, {user.first_name}</span>
                  <a href="/profile" className="mr-4 hover:underline">Профиль</a>
                  <a href="/bookings" className="mr-4 hover:underline">Бронирования</a>
                  <button onClick={logout} className="hover:underline">Выйти</button>
                </>
              ) : (
                <>
                  <a href="/login" className="mr-4 hover:underline">Войти</a>
                  <a href="/register" className="hover:underline">Регистрация</a>
                </>
              )}
            </div>
          </div>
        </nav>
      );
    };

    // Компонент для домашней страницы
    const Home = () => {
      const [rooms, setRooms] = useState([]);
      const [checkIn, setCheckIn] = useState('');
      const [checkOut, setCheckOut] = useState('');

      useEffect(() => {
        axios.get('/api/v1/rooms/')
          .then(response => setRooms(response.data.rooms))
          .catch(error => console.error('Ошибка загрузки номеров:', error));
      }, []);

      const searchRooms = async () => {
        try {
          const response = await axios.post('http://127.0.0.1:8000/api/v1/rooms/available/', {
            check_in_date: checkIn,
            check_out_date: checkOut
          });
          setRooms(response.data.available_rooms);
        } catch (error) {
          console.error('Ошибка поиска номеров:', error);
        }
      };

      return (
        <div className="container mx-auto p-4">
          <h2 className="text-3xl font-bold mb-4">Доступные номера</h2>
          <div className="mb-4 flex space-x-4">
            <input
              type="date"
              value={checkIn}
              onChange={e => setCheckIn(e.target.value)}
              className="border p-2 rounded"
            />
            <input
              type="date"
              value={checkOut}
              onChange={e => setCheckOut(e.target.value)}
              className="border p-2 rounded"
            />
            <button
              onClick={searchRooms}
              className="bg-blue-600 text-white p-2 rounded hover:bg-blue-700"
            >
              Поиск
            </button>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {rooms.map(room => (
              <div key={room.room_number} className="border rounded-lg p-4 shadow-lg">
                <img src={`/media/${room.photo}`} alt={room.room_name} className="w-full h-48 object-cover rounded" />
                <h3 className="text-xl font-semibold">{room.room_name}</h3>
                <p>Тип: {room.room_type}</p>
                <p>Цена за ночь: {room.price_per_night} ₽</p>
                <p>Вместимость: {room.capacity} человек</p>
                <p>{room.description}</p>
                <a
                  href={`/rooms/${room.room_number}`}
                  className="mt-2 inline-block bg-blue-600 text-white p-2 rounded hover:bg-blue-700"
                >
                  Подробнее
                </a>
              </div>
            ))}
          </div>
        </div>
      );
    };

    // Компонент для страницы номера
    const RoomDetail = ({ roomId }) => {
      const [room, setRoom] = useState(null);

      useEffect(() => {
        axios.get(`http://127.0.0.1:8000/api/v1/rooms/${roomId}/`)
          .then(response => setRoom(response.data))
          .catch(error => console.error('Ошибка загрузки номера:', error));
      }, [roomId]);

      if (!room) return <div>Загрузка...</div>;

      return (
        <div className="container mx-auto p-4">
          <h2 className="text-3xl font-bold mb-4">{room.room.room_name}</h2>
          <img src={`/media/${room.room.photo}`} alt={room.room.room_name} className="w-full h-96 object-cover rounded mb-4" />
          <p>Тип: {room.room.room_type}</p>
          <p>Цена за ночь: {room.room.price_per_night} ₽</p>
          <p>Вместимость: {room.room.capacity} человек</p>
          <p>{room.room.description}</p>
          <div className="grid grid-cols-2 gap-4 mt-4">
            {room.photos.map(photo => (
              <img key={photo.id} src={`/media/${photo.image}`} alt="Room photo" className="w-full h-48 object-cover rounded" />
            ))}
          </div>
        </div>
      );
    };

    // Компонент для регистрации
    const Register = () => {
      const [formData, setFormData] = useState({
        username: '', password: '', password2: '', email: '', first_name: '', last_name: '', phone_number: ''
      });

      const handleChange = e => {
        setFormData({ ...formData, [e.target.name]: e.target.value });
      };

      const handleSubmit = async () => {
        try {
          await axios.post('http://127.0.0.1:8000/api/v1/users/register/', formData);
          alert('Регистрация успешна! Пожалуйста, войдите.');
          window.location.href = '/login';
        } catch (error) {
          console.error('Ошибка регистрации:', error);
          alert('Ошибка регистрации');
        }
      };

      return (
        <div className="container mx-auto p-4 max-w-md">
          <h2 className="text-3xl font-bold mb-4">Регистрация</h2>
          <div className="space-y-4">
            {['username', 'email', 'first_name', 'last_name', 'phone_number', 'password', 'password2'].map(field => (
              <input
                key={field}
                type={field.includes('password') ? 'password' : 'text'}
                name={field}
                placeholder={field.replace('_', ' ')}
                value={formData[field]}
                onChange={handleChange}
                className="w-full border p-2 rounded"
              />
            ))}
            <button
              onClick={handleSubmit}
              className="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700"
            >
              Зарегистрироваться
            </button>
          </div>
        </div>
      );
    };

    // Компонент для входа
    const Login = () => {
      const { login } = React.useContext(AuthContext);
      const [formData, setFormData] = useState({ username: '', password: '' });

      const handleChange = e => {
        setFormData({ ...formData, [e.target.name]: e.target.value });
      };

      const handleSubmit = async () => {
        try {
          await login(formData.username, formData.password);
          window.location.href = '/';
        } catch (error) {
          alert('Ошибка входа');
        }
      };

      return (
        <div className="container mx-auto p-4 max-w-md">
          <h2 className="text-3xl font-bold mb-4">Вход</h2>
          <div className="space-y-4">
            <input
              type="text"
              name="username"
              placeholder="Имя пользователя"
              value={formData.username}
              onChange={handleChange}
              className="w-full border p-2 rounded"
            />
            <input
              type="password"
              name="password"
              placeholder="Пароль"
              value={formData.password}
              onChange={handleChange}
              className="w-full border p-2 rounded"
            />
            <button
              onClick={handleSubmit}
              className="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700"
            >
              Войти
            </button>
          </div>
        </div>
      );
    };

    // Компонент для профиля
    const Profile = () => {
      const { user } = React.useContext(AuthContext);
      const [formData, setFormData] = useState(user || {});

      useEffect(() => {
        setFormData(user || {});
      }, [user]);

      const handleChange = e => {
        setFormData({ ...formData, [e.target.name]: e.target.value });
      };

      const handleSubmit = async () => {
        try {
          await axios.put('http://127.0.0.1:8000/api/v1/users/profile/', formData, {
            headers: { Authorization: `Bearer ${localStorage.getItem('access_token')}` }
          });
          alert('Профиль обновлен');
        } catch (error) {
          console.error('Ошибка обновления профиля:', error);
          alert('Ошибка обновления профиля');
        }
      };

      if (!user) return <div>Необходимо войти</div>;

      return (
        <div className="container mx-auto p-4 max-w-md">
          <h2 className="text-3xl font-bold mb-4">Профиль</h2>
          <div className="space-y-4">
            {['email', 'first_name', 'last_name', 'phone_number'].map(field => (
              <input
                key={field}
                type="text"
                name={field}
                placeholder={field.replace('_', ' ')}
                value={formData[field] || ''}
                onChange={handleChange}
                className="w-full border p-2 rounded"
              />
            ))}
            <button
              onClick={handleSubmit}
              className="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700"
            >
              Обновить
            </button>
          </div>
        </div>
      );
    };

    // Компонент для бронирований
    const Bookings = () => {
      const { user } = React.useContext(AuthContext);
      const [bookings, setBookings] = useState([]);
      const [formData, setFormData] = useState({ room_id: '', check_in_date: '', check_out_date: '' });

      useEffect(() => {
        axios.get('http://127.0.0.1:8000/api/v1/users/bookings/', {
          headers: { Authorization: `Bearer ${localStorage.getItem('access_token')}` }
        })
          .then(response => setBookings(response.data))
          .catch(error => console.error('Ошибка загрузки бронирований:', error));
      }, []);

      const handleChange = e => {
        setFormData({ ...formData, [e.target.name]: e.target.value });
      };

      const handleSubmit = async () => {
        try {
          await axios.post('http://127.0.0.1:8000/api/v1/users/bookings/', formData, {
            headers: { Authorization: `Bearer ${localStorage.getItem('access_token')}` }
          });
          alert('Бронирование создано');
          window.location.reload();
        } catch (error) {
          console.error('Ошибка создания бронирования:', error);
          alert('Ошибка создания бронирования');
        }
      };

      const cancelBooking = async (bookingId) => {
        try {
          await axios.delete(`http://127.0.0.1:8000/api/v1/users/bookings/${bookingId}/`, {
            headers: { Authorization: `Bearer ${localStorage.getItem('access_token')}` }
          });
          alert('Бронирование отменено');
          window.location.reload();
        } catch (error) {
          console.error('Ошибка отмены бронирования:', error);
          alert('Ошибка отмены бронирования');
        }
      };

      if (!user) return <div>Необходимо войти</div>;

      return (
        <div className="container mx-auto p-4">
          <h2 className="text-3xl font-bold mb-4">Мои бронирования</h2>
          <div className="mb-4">
            <h3 className="text-xl font-semibold mb-2">Новое бронирование</h3>
            <div className="space-y-4">
              <input
                type="number"
                name="room_id"
                placeholder="ID номера"
                value={formData.room_id}
                onChange={handleChange}
                className="w-full border p-2 rounded"
              />
              <input
                type="date"
                name="check_in_date"
                value={formData.check_in_date}
                onChange={handleChange}
                className="w-full border p-2 rounded"
              />
              <input
                type="date"
                name="check_out_date"
                value={formData.check_out_date}
                onChange={handleChange}
                className="w-full border p-2 rounded"
              />
              <button
                onClick={handleSubmit}
                className="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700"
              >
                Забронировать
              </button>
            </div>
          </div>
          <div className="space-y-4">
            {bookings.map(booking => (
              <div key={booking.id} className="border rounded-lg p-4 shadow-lg">
                <p>Номер: {booking.room_id}</p>
                <p>Заезд: {booking.check_in_date}</p>
                <p>Выезд: {booking.check_out_date}</p>
                <p>Цена: {booking.total_price} ₽</p>
                <p>Статус: {booking.status}</p>
                <button
                  onClick={() => cancelBooking(booking.id)}
                  className="mt-2 bg-red-600 text-white p-2 rounded hover:bg-red-700"
                >
                  Отменить
                </button>
              </div>
            ))}
          </div>
        </div>
      );
    };

    // Компонент маршрутизации
    const App = () => {
      const [path, setPath] = useState(window.location.pathname);

      useEffect(() => {
        const handlePopState = () => setPath(window.location.pathname);
        window.addEventListener('popstate', handlePopState);
        return () => window.removeEventListener('popstate', handlePopState);
      }, []);

      const navigate = (url) => {
        window.history.pushState({}, '', url);
        setPath(url);
      };

      return (
        <AuthProvider>
          <Navbar />
          {path === '/' && <Home />}
          {path === '/register' && <Register />}
          {path === '/login' && <Login />}
          {path === '/profile' && <Profile />}
          {path === '/bookings' && <Bookings />}
          {path.startsWith('/rooms/') && <RoomDetail roomId={path.split('/')[2]} />}
        </AuthProvider>
      );
    };

    // Рендеринг приложения
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>